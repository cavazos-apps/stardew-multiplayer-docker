# Pull base image.
FROM jlesage/baseimage-gui:debian-12-v4

# Steam appId - can be overridden at runtime
ENV SRCDS_APPID=413150

# Set the name of the application.
ENV APP_NAME="StardewValley"
## Uses a distinct PATH from Stardew/game/ that GOG has.
ENV GAME_PATH="/data/Stardew/game"

## lib32gcc-s1 is required for steamcmd
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" \
    wget unzip tar strace xterm gettext-base jq netcat-openbsd procps lib32gcc-s1 locales && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" mono-complete && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Game + ModLoader 1.6.15 4.3.2

RUN mkdir -p ${GAME_PATH} && \
    mkdir -p /data/nexus && \
    mkdir -p /data/steamcmd

## FOR STEAM VERSION
RUN wget https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz -qO steamcmd.tar.gz && \
    tar -xzvf steamcmd.tar.gz -C /data/steamcmd && \
    cd /data/steamcmd

## Generate en_US.UTF-8 locale require by steam incase missing
RUN sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen && \
        dpkg-reconfigure --frontend=noninteractive locales

## Update steam to prevent steamguard code timeout
RUN /data/steamcmd/steamcmd.sh +quit

## Set up permissions and directories for runtime Steam download
RUN chown -R 1000:1000 /data && \
    mkdir -p /data/.steam/sdk32 /data/.steam/sdk64
## END STEAM VERSION

RUN mkdir -p /usr/share/dotnet && \
    wget -qO dotnet.tar.gz https://download.visualstudio.microsoft.com/download/pr/7bc2f0a5-f0c1-4b6e-9e49-0ee13d9ddc85/d77e63c36d01bc0ae72ee54cf40c74c1/dotnet-sdk-5.0.408-linux-x64.tar.gz && \
    tar -zxf dotnet.tar.gz -C /usr/share/dotnet && \
    rm dotnet.tar.gz && \
    ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet

# Download SMAPI installer for runtime installation
RUN wget --user-agent="Mozilla" https://github.com/Pathoschild/SMAPI/releases/download/4.3.2/SMAPI-4.3.2-installer.zip -qO /data/nexus.zip && \
    unzip /data/nexus.zip -d /data/nexus/

# Add Mods & Scripts (stored as templates for runtime deployment)
COPY ["mods/", "/data/Stardew/mods_template/"]
COPY scripts/ /opt/

RUN chmod -R 775 /data/Stardew && \
    chown -R 1000:1000 /data/Stardew && \
    chmod +x /opt/*.sh

RUN mkdir /etc/services.d/utils && touch /etc/services.d/app/utils.dep
COPY run /etc/services.d/utils/run 
RUN chmod +x /etc/services.d/utils/run 

COPY start.sh /data/Stardew/start.sh.template
RUN chmod +x /data/Stardew/start.sh.template
COPY steam-init.sh /opt/steam-init.sh
RUN chmod +x /opt/steam-init.sh
COPY docker-entrypoint-steam.sh /startapp.sh
RUN chmod +x /startapp.sh
